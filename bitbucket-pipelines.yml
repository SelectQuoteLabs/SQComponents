image: tstrohmeier/awscli:3.6.4

definitions:
  services:
    docker:
      memory: 3072

# Repeatable Steps
commonBuildAndDeploy: &commonBuildAndDeploy
  name: Build & Deploy
  script:
    - pip install -U awscli
    - eval $(aws ecr get-login --region ${AWS_DEFAULT_REGION} --no-include-email)
    - export TAG=${ENVIRONMENT}_${BITBUCKET_BUILD_NUMBER}
    - export LABEL=${AWS_REGISTRY_URL}:$TAG
    - >
      docker build
      -t scplus-shared-components:$TAG
      --build-arg ENVIRONMENT=${ENVIRONMENT}
      .
    - docker push $LABEL
    - sed -i -e "s|__LABEL__|$LABEL|g" task-definition.json
    - sed -i -e "s|__ENV__|${ENV}|g" task-definition.json
    - sed -i -e "s|__EXECUTION_ROLE_ARN__|${EXECUTION_ROLE}|g" task-definition.json
    - sed -i -e "s|__TASK_ROLE_ARN__|${TASK_ROLE}|g" task-definition.json
    - sed -i -e "s|__NGINX_REPO__|${NGINX_REPO}|g" task-definition.json 
    - >
      aws ecs register-task-definition
      --family scplus-shared-components
      --cli-input-json file://task-definition.json
    - >
      aws ecs update-service
      --service scplus-shared-components
      --task-definition scplus-shared-components
      --cluster SharedServices
  services:
    - docker

pipelines:
  custom:
    production:
      - step:
          deployment: production
          <<: *commonBuildAndDeploy

  branches:
    master:
      - step:
          deployment: production
          <<: *commonBuildAndDeploy
